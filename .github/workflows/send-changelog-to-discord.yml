name: Notify Discord on Changelog Update

on:
  push:
    paths:
      - 'CHANGELOG.md'

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Get commit SHA
        id: get-sha
        run: echo "CURRENT_SHA=$(git rev-parse HEAD)" >> $GITHUB_ENV

      - name: Fetch previous commit
        id: fetch-prev
        run: |
          git fetch --depth=2
          echo "PREVIOUS_SHA=$(git rev-parse HEAD^)" >> $GITHUB_ENV

      - name: Get changed files
        id: get_changes
        run: |
          git diff --name-only ${{ env.PREVIOUS_SHA }} ${{ env.CURRENT_SHA }} > changes.txt
          cat changes.txt
          CHANGED_FILES=$(cat changes.txt)
          echo "CHANGED_FILES=$CHANGED_FILES" >> $GITHUB_ENV

      - name: Check if CHANGELOG.md was updated
        id: check_changelog
        run: |
          if echo "${{ env.CHANGED_FILES }}" | grep -q 'CHANGELOG.md'; then
            echo "CHANGELOG_MD_UPDATED=true" >> $GITHUB_ENV
          else
            echo "CHANGELOG_MD_UPDATED=false" >> $GITHUB_ENV
          fi

      - name: Get content of CHANGELOG.md
        if: ${{ env.CHANGELOG_MD_UPDATED == 'true' }}
        id: get_content
        run: |
          cat CHANGELOG.md > changelog_content.txt
          CHANGES_CONTENT=$(cat changelog_content.txt)
          echo "CHANGES_CONTENT=$CHANGES_CONTENT" >> $GITHUB_ENV

      - name: Send update to Discord
        if: ${{ env.CHANGELOG_MD_UPDATED == 'true' }}
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          curl -H "Content-Type: application/json" -X POST -d "{\"content\": \"CHANGELOG.md was updated!\n\n\`${{ env.CHANGES_CONTENT }}\`\"}" $DISCORD_WEBHOOK
